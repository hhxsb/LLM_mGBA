<!DOCTYPE html>
<html>
<head>
    <title>üéÆ AI GBA Player</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
</head>
<body>
    <div class="app-container">
        <div class="config-panel">
            <div class="config-header">
                <h2>üéÆ AI GBA Player</h2>
                <div class="status-indicator" id="service-status">
                    <span class="status-stopped">üîå Connection Ready</span>
                </div>
            </div>
            <div class="config-content">
                <div class="config-section">
                    <h3>üîó mGBA Connection</h3>
                    <button class="btn btn-success" onclick="startService()">üîó Reset mGBA Connection</button>
                    <button class="btn btn-outline" onclick="stopService()">üîå Stop Connection</button>
                    <button class="btn btn-primary" onclick="launchMGBA()">üéÆ Launch mGBA</button>
                </div>
                <div class="config-section">
                    <h3>üéÆ ROM Configuration</h3>
                    <div class="form-group">
                        <label>ROM File Path</label>
                        <input type="text" id="rom-path" value="{{ config.rom_path }}" placeholder="/path/to/game.gba">
                    </div>
                    <div class="form-group">
                        <label>mGBA Executable</label>
                        <input type="text" id="mgba-path" value="{{ config.mgba_path }}" placeholder="/Applications/mGBA.app/Contents/MacOS/mGBA">
                    </div>
                    <button class="btn btn-outline" onclick="saveConfig()">üíæ Save Config</button>
                </div>
                <div class="config-section">
                    <h3>ü§ñ AI Settings</h3>
                    <div class="form-group">
                        <label>LLM Provider</label>
                        <select id="llm-provider">
                            <option value="gemini" {% if config.llm_provider == "gemini" %}selected{% endif %}>Google Gemini</option>
                            <option value="openai" {% if config.llm_provider == "openai" %}selected{% endif %}>OpenAI</option>
                            <option value="anthropic" {% if config.llm_provider == "anthropic" %}selected{% endif %}>Anthropic</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" id="api-key" value="{{ config.api_key }}" placeholder="Enter API key">
                    </div>
                    <div class="form-group">
                        <label>Decision Cooldown (seconds)</label>
                        <input type="number" id="cooldown" value="{{ config.cooldown }}" min="1" max="10">
                    </div>
                    
                    <details style="margin: 15px 0; border: 1px solid #e1e8ed; border-radius: 6px;">
                        <summary style="padding: 10px; cursor: pointer; background: #f8f9fa; font-weight: 500;">‚è±Ô∏è Advanced Timing Settings</summary>
                        <div style="padding: 10px;">
                            <div class="form-group">
                                <label>Base Stabilization (seconds)</label>
                                <input type="number" id="base-stabilization" value="{{ config.base_stabilization }}" min="0.1" max="2.0" step="0.1">
                                <small style="color: #6b7280; font-size: 11px;">Minimum wait time for game state to stabilize</small>
                            </div>
                            <div class="form-group">
                                <label>Movement Delay (seconds)</label>
                                <input type="number" id="movement-multiplier" value="{{ config.movement_multiplier }}" min="0.1" max="1.0" step="0.1">
                                <small style="color: #6b7280; font-size: 11px;">Extra delay for movement actions (UP/DOWN/LEFT/RIGHT)</small>
                            </div>
                            <div class="form-group">
                                <label>Interaction Delay (seconds)</label>
                                <input type="number" id="interaction-multiplier" value="{{ config.interaction_multiplier }}" min="0.1" max="1.0" step="0.1">
                                <small style="color: #6b7280; font-size: 11px;">Extra delay for interaction actions (A/B buttons)</small>
                            </div>
                            <div class="form-group">
                                <label>Menu Delay (seconds)</label>
                                <input type="number" id="menu-multiplier" value="{{ config.menu_multiplier }}" min="0.2" max="2.0" step="0.1">
                                <small style="color: #6b7280; font-size: 11px;">Extra delay for menu actions (START/SELECT)</small>
                            </div>
                            <div class="form-group">
                                <label>Maximum Wait Time (seconds)</label>
                                <input type="number" id="max-wait-time" value="{{ config.max_wait_time }}" min="1" max="10" step="0.5">
                                <small style="color: #6b7280; font-size: 11px;">Maximum total wait time regardless of actions</small>
                            </div>
                        </div>
                    </details>
                    
                    <button class="btn btn-outline" onclick="saveAIConfig()">üíæ Save AI Config</button>
                    <button class="btn btn-outline" onclick="resetLLMSession()" style="background: #fd7e14; color: white; margin-top: 10px;">üîÑ Reset LLM Session</button>
                </div>
                <div class="config-section">
                    <h3>üß† Memory System Configuration</h3>
                    
                    <!-- Memory System Status -->
                    <div class="memory-status-section">
                        <div class="memory-header">
                            <span class="memory-status" id="memory-status">Loading...</span>
                            <span class="memory-stats" id="memory-stats">0 objectives, 0 strategies</span>
                        </div>
                        <button class="btn btn-outline btn-sm" onclick="testMemoryConnections()">üîß Test Connections</button>
                        <button class="btn btn-outline btn-sm" onclick="resetMemorySystem()">üîÑ Reset Memory System</button>
                    </div>

                    <!-- Memory Configuration Form -->
                    <details style="margin: 15px 0; border: 1px solid #e1e8ed; border-radius: 6px;">
                        <summary style="padding: 10px; cursor: pointer; background: #f8f9fa; font-weight: 500;">‚öôÔ∏è Memory System Settings</summary>
                        <div style="padding: 15px;">
                            
                            <!-- Basic Settings -->
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="memory-enabled" checked> Enable Memory System
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label>System Type</label>
                                <select id="memory-system-type">
                                    <option value="auto">Auto-detect (Recommended)</option>
                                    <option value="graphiti">Graphiti (Advanced AI Memory)</option>
                                    <option value="simple">Simple (Text-based)</option>
                                </select>
                                <small style="color: #6b7280; font-size: 11px;">Auto-detect uses Graphiti if available, otherwise Simple</small>
                            </div>

                            <!-- LLM Provider Settings -->
                            <div class="form-group">
                                <label>LLM Provider for Memory</label>
                                <select id="memory-llm-provider">
                                    <option value="inherit">Inherit from AI Settings</option>
                                    <option value="google">Google Gemini</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Anthropic</option>
                                </select>
                            </div>

                            <!-- API Keys Section -->
                            <details style="margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                                <summary style="padding: 8px; cursor: pointer; background: #f5f5f5; font-size: 14px;">üîê Memory System API Keys (Optional)</summary>
                                <div style="padding: 10px;">
                                    <small style="color: #6b7280; margin-bottom: 10px; display: block;">Only needed if not using "Inherit from AI Settings"</small>
                                    
                                    <div class="form-group">
                                        <label>Google Gemini API Key</label>
                                        <input type="password" id="memory-google-api-key" placeholder="Enter Google API key">
                                    </div>
                                    <div class="form-group">
                                        <label>OpenAI API Key</label>
                                        <input type="password" id="memory-openai-api-key" placeholder="Enter OpenAI API key">
                                    </div>
                                    <div class="form-group">
                                        <label>Anthropic API Key</label>
                                        <input type="password" id="memory-anthropic-api-key" placeholder="Enter Anthropic API key">
                                    </div>
                                </div>
                            </details>

                            <!-- Neo4j Configuration -->
                            <details style="margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                                <summary style="padding: 8px; cursor: pointer; background: #f5f5f5; font-size: 14px;">üóÑÔ∏è Neo4j Database Configuration</summary>
                                <div style="padding: 10px;">
                                    <div class="form-group">
                                        <label>Neo4j URI</label>
                                        <input type="text" id="memory-neo4j-uri" value="bolt://localhost:7687" placeholder="bolt://localhost:7687">
                                        <small style="color: #6b7280; font-size: 11px;">Neo4j connection string</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Username</label>
                                        <input type="text" id="memory-neo4j-username" value="neo4j" placeholder="neo4j">
                                    </div>
                                    <div class="form-group">
                                        <label>Password</label>
                                        <input type="password" id="memory-neo4j-password" placeholder="Neo4j password">
                                    </div>
                                    <div class="form-group">
                                        <label>Database</label>
                                        <input type="text" id="memory-neo4j-database" value="neo4j" placeholder="neo4j">
                                    </div>
                                </div>
                            </details>

                            <!-- Advanced Graphiti Settings -->
                            <details style="margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                                <summary style="padding: 8px; cursor: pointer; background: #f5f5f5; font-size: 14px;">üéõÔ∏è Advanced Graphiti Settings</summary>
                                <div style="padding: 10px;">
                                    <div class="form-group">
                                        <label>LLM Model</label>
                                        <input type="text" id="memory-graphiti-llm-model" value="gemini-2.0-flash" placeholder="gemini-2.0-flash">
                                        <small style="color: #6b7280; font-size: 11px;">Model for reasoning and text generation</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Embedding Model</label>
                                        <input type="text" id="memory-graphiti-embedding-model" value="embedding-001" placeholder="embedding-001">
                                        <small style="color: #6b7280; font-size: 11px;">Model for text embeddings</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Reranker Model</label>
                                        <input type="text" id="memory-graphiti-reranker-model" value="gemini-2.5-flash-lite-preview-06-17" placeholder="gemini-2.5-flash-lite-preview-06-17">
                                        <small style="color: #6b7280; font-size: 11px;">Model for search result ranking</small>
                                    </div>
                                </div>
                            </details>

                            <!-- Fallback Settings -->
                            <details style="margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                                <summary style="padding: 8px; cursor: pointer; background: #f5f5f5; font-size: 14px;">üîß Error Handling</summary>
                                <div style="padding: 10px;">
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="memory-auto-fallback" checked> Auto-fallback to Simple Memory
                                        </label>
                                        <small style="color: #6b7280; font-size: 11px; display: block;">Automatically use Simple Memory if Graphiti fails</small>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="memory-fallback-on-error" checked> Fallback on Runtime Errors
                                        </label>
                                        <small style="color: #6b7280; font-size: 11px; display: block;">Switch to Simple Memory if Graphiti encounters errors during operation</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Retry Attempts</label>
                                        <input type="number" id="memory-retry-attempts" value="3" min="1" max="10">
                                        <small style="color: #6b7280; font-size: 11px;">Number of retry attempts before falling back</small>
                                    </div>
                                </div>
                            </details>

                            <button class="btn btn-primary" onclick="saveMemoryConfig()" style="margin-top: 15px;">üíæ Save Memory Configuration</button>
                        </div>
                    </details>

                    <!-- Memory System Display (Current Objectives & Strategies) -->
                    <div class="memory-display" id="memory-display" style="margin-top: 15px;">
                        <!-- Objectives Panel -->
                        <div class="memory-section">
                            <h4>üéØ Current Objectives</h4>
                            <div class="objectives-list" id="objectives-list">
                                <div class="memory-empty">No objectives yet...</div>
                            </div>
                            <div class="add-objective-form">
                                <input type="text" id="objective-input" placeholder="Add new objective..." maxlength="100">
                                <select id="objective-priority">
                                    <option value="5">Normal (5)</option>
                                    <option value="7">High (7)</option>
                                    <option value="9">Critical (9)</option>
                                </select>
                                <button class="btn btn-sm" onclick="addObjective()">‚ûï Add</button>
                            </div>
                        </div>
                        
                        <!-- Strategies Panel -->
                        <div class="memory-section">
                            <h4>üí° Learned Strategies</h4>
                            <div class="strategies-list" id="strategies-list">
                                <div class="memory-empty">No strategies learned yet...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">üí¨ AI Game Session</div>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="welcome-message">
                    <h3>üéÆ AI GBA Player Ready</h3>
                    <p>Configure your ROM and AI settings, then start the service to begin.</p>
                    <p>Images sent to AI and AI responses will appear here.</p>
                </div>
            </div>
            <!-- Narration Banner -->
            <div class="narration-banner" id="narrationBanner" style="display: none;">
                <div class="narration-content">
                    <div class="narration-icon">üé§</div>
                    <div class="narration-text">
                        <div class="narration-main" id="narrationMain">Narration will appear here...</div>
                        <div class="narration-meta" id="narrationMeta">
                            <span class="energy-level" id="energyLevel">neutral</span>
                            <span class="tts-status" id="ttsStatus"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-controls">
                <div class="controls-row">
                    <button class="control-btn" onclick="clearChat()">üóëÔ∏è Clear Chat</button>
                    <button class="control-btn" onclick="exportChat()">üì• Export</button>
                    <button class="control-btn" onclick="toggleAutoScroll()" id="auto-scroll-btn">üîÑ Auto-scroll: ON</button>
                    <span style="margin-left: auto; font-size: 12px; color: #6b7280;">
                        <span id="message-count">0</span> messages
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Load JavaScript from separate file -->
    <script src="{% static 'dashboard/js/dashboard.js' %}"></script>
</body>
</html>