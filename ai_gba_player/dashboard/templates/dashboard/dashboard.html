{% extends 'dashboard/base.html' %}

{% block content %}
{% csrf_token %}
<div class="dashboard-container">
    <!-- Quick Actions Panel -->
    <div class="quick-actions-panel">
        <h2>üöÄ Quick Actions</h2>
        <div class="actions-grid">
            <div class="action-card">
                <h3>üéÆ Launch Game</h3>
                {% if config.rom_path %}
                    <p>ROM: <strong>{{ config.rom_display_name|default:"Auto-Generated" }}</strong></p>
                    <button onclick="launchGameFromConfig()" class="action-btn primary">
                        üöÄ Launch mGBA
                    </button>
                {% else %}
                    <p>No ROM configured</p>
                    <a href="{% url 'config' %}" class="action-btn">Configure ROM</a>
                {% endif %}
            </div>
            
            <div class="action-card">
                <h3>‚öôÔ∏è Game Service</h3>
                {% if unified_service %}
                    <p>Status: <span class="status {{ unified_service.status }}">{{ unified_service.get_status_display }}</span></p>
                    <button onclick="restartService()" class="action-btn success">
                        üîÑ Restart Service
                    </button>
                {% else %}
                    <p>Service not initialized</p>
                    <button onclick="restartService()" class="action-btn">
                        üîÑ Start Service
                    </button>
                {% endif %}
            </div>
            
            <div class="action-card">
                <h3>üìÇ ROM Configuration</h3>
                {% if config.rom_path %}
                    <p>ROM: <strong>{{ config.rom_path|truncatechars:30 }}</strong></p>
                {% else %}
                    <p>No ROM configured</p>
                {% endif %}
                <a href="{% url 'config' %}" class="action-btn">
                    ‚öôÔ∏è Configure ROM
                </a>
            </div>
            
            <div class="action-card">
                <h3>üîß System Control</h3>
                <p>Advanced process management</p>
                <a href="{% url 'admin_panel' %}" class="action-btn">
                    üõ†Ô∏è Admin Panel
                </a>
            </div>
            
            <div class="action-card">
                <h3>üß† LLM Session</h3>
                <p>Reset AI conversation memory</p>
                <button onclick="resetLLMSession()" class="action-btn warning">
                    üîÑ Reset LLM Session
                </button>
            </div>
        </div>
    </div>

    <!-- System Status Panel -->
    <div class="status-panel">
        <h2>üñ•Ô∏è System Status</h2>
        <div class="status-grid" id="statusGrid">
            <div class="status-card">
                <h3>üéÆ Unified Service</h3>
                <div class="status-indicator" id="unifiedServiceStatus">
                    {% if unified_service %}
                        <span class="status {{ unified_service.status }}">
                            {% if unified_service.status == 'running' %}‚úÖ Running
                            {% elif unified_service.status == 'starting' %}‚è≥ Starting
                            {% elif unified_service.status == 'error' %}‚ùå Error
                            {% else %}‚è∏Ô∏è Stopped{% endif %}
                        </span>
                    {% else %}
                        ‚è∏Ô∏è Not initialized
                    {% endif %}
                </div>
            </div>
            <div class="status-card">
                <h3>üìπ Video Capture</h3>
                <div class="status-indicator" id="videoCaptureStatus">
                    {% if unified_service and unified_service.status == 'running' %}
                        ‚úÖ Active
                    {% else %}
                        ‚è∏Ô∏è Inactive
                    {% endif %}
                </div>
            </div>
            <div class="status-card">
                <h3>üß† Knowledge System</h3>
                <div class="status-indicator" id="knowledgeSystemStatus">
                    {% if unified_service and unified_service.status == 'running' %}
                        ‚úÖ Active
                    {% else %}
                        ‚è∏Ô∏è Inactive
                    {% endif %}
                </div>
            </div>
            <div class="status-card">
                <h3>üìä Connection</h3>
                <div class="status-indicator" id="connectionStatus">üîÑ Connecting...</div>
            </div>
        </div>
    </div>
    
    <!-- Chat Interface -->
    <div class="chat-panel">
        <div class="chat-header">
            <h2>üí¨ AI Game Session</h2>
            <div class="chat-controls">
                <button class="btn btn-clear" onclick="clearChat()">üóëÔ∏è Clear</button>
                <button class="btn btn-export" onclick="exportMessages()">üì• Export</button>
            </div>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="chat-messages" id="chatMessages">
                <!-- Welcome message -->
                <div class="message-welcome">
                    <div class="welcome-icon">üéÆ</div>
                    <h3>AI GBA Player Ready</h3>
                    <p>Ready to watch AI play any Game Boy Advance game...</p>
                    <p>Game footage, AI decisions, and actions will appear here.</p>
                </div>
            </div>
        </div>
        
        <div class="chat-footer">
            <div class="chat-stats">
                <span id="chatMessageCount">0 messages in chat</span>
                <span>üîÑ Auto-scroll enabled</span>
            </div>
        </div>
    </div>
</div>

<!-- Chat Message Templates -->
<template id="gifMessageTemplate">
    <div class="message gif-message">
        <div class="message-header">
            <span class="message-icon">üéÆ</span>
            <span class="message-type">Game Footage</span>
            <span class="message-time"></span>
        </div>
        <div class="message-content">
            <img class="gif-image" alt="Game GIF">
            <div class="gif-metadata">
                <span class="frame-count"></span>
                <span class="duration"></span>
                <span class="file-size"></span>
            </div>
        </div>
    </div>
</template>

<template id="screenshotsMessageTemplate">
    <div class="message screenshots-message">
        <div class="message-header">
            <span class="message-icon">üì∏</span>
            <span class="message-type">Game Screenshots</span>
            <span class="message-time"></span>
        </div>
        <div class="message-content">
            <div class="screenshots-grid">
                <div class="screenshot-before">
                    <div class="screenshot-label">
                        <span class="indicator before"></span>
                        Before Action
                    </div>
                    <img class="screenshot-image" alt="Before Action">
                </div>
                <div class="screenshot-after">
                    <div class="screenshot-label">
                        <span class="indicator after"></span>
                        After Action
                    </div>
                    <img class="screenshot-image" alt="After Action">
                </div>
            </div>
            <div class="screenshots-metadata">
                <span class="dimensions"></span>
                <span class="source"></span>
                <span class="count"></span>
            </div>
        </div>
    </div>
</template>

<template id="responseMessageTemplate">
    <div class="message response-message">
        <div class="message-header">
            <span class="message-icon">ü§ñ</span>
            <span class="message-type">AI Response</span>
            <span class="message-time"></span>
        </div>
        <div class="message-content">
            <div class="response-text"></div>
            <details class="response-reasoning">
                <summary>üí≠ Reasoning</summary>
                <div class="reasoning-content"></div>
            </details>
            <div class="response-metadata">
                <span class="confidence"></span>
                <span class="processing-time"></span>
            </div>
        </div>
    </div>
</template>

<template id="actionMessageTemplate">
    <div class="message action-message">
        <div class="message-header">
            <span class="message-icon">üéØ</span>
            <span class="message-type">Actions</span>
            <span class="message-time"></span>
        </div>
        <div class="message-content">
            <div class="action-buttons"></div>
            <div class="action-durations"></div>
        </div>
    </div>
</template>

<template id="systemMessageTemplate">
    <div class="message system-message">
        <div class="message-header">
            <span class="message-icon"></span>
            <span class="message-type">System</span>
            <span class="message-time"></span>
        </div>
        <div class="message-content">
            <div class="system-text"></div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard-specific JavaScript
function clearChat() {
    if (window.dashboardWS) {
        window.dashboardWS.clearChat();
    }
}

function exportMessages() {
    if (window.dashboardWS) {
        window.dashboardWS.exportMessages();
    }
}

async function launchGameFromConfig() {
    try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const response = await fetch('/api/launch-mgba-config/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message, 'success');
        } else {
            showNotification(result.message, 'error');
        }
    } catch (error) {
        showNotification('Failed to launch mGBA: ' + error.message, 'error');
    }
}

async function restartService() {
    try {
        // Update UI to show restarting
        const serviceStatus = document.getElementById('unifiedServiceStatus');
        serviceStatus.innerHTML = '<span class="status starting">‚è≥ Restarting...</span>';
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const response = await fetch('/api/restart-service/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message, 'success');
            // Refresh page after a delay to show updated status
            setTimeout(() => window.location.reload(), 2000);
        } else {
            showNotification(result.message, 'error');
            // Reset status on error
            serviceStatus.innerHTML = '<span class="status error">‚ùå Error</span>';
        }
    } catch (error) {
        showNotification('Failed to restart service: ' + error.message, 'error');
        const serviceStatus = document.getElementById('unifiedServiceStatus');
        serviceStatus.innerHTML = '<span class="status error">‚ùå Error</span>';
    }
}

async function resetLLMSession() {
    try {
        // Show loading state
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '‚è≥ Resetting...';
        button.disabled = true;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const response = await fetch('/api/reset-llm-session/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message, 'success');
            // Flash the button to show success
            button.innerHTML = '‚úÖ Reset!';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        } else {
            showNotification(result.message, 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        }
    } catch (error) {
        showNotification('Failed to reset LLM session: ' + error.message, 'error');
        button.innerHTML = 'üîÑ Reset LLM Session';
        button.disabled = false;
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1001;
        padding: 12px 20px;
        border-radius: 4px;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-weight: 500;
    `;
    
    // Set colors based on type
    if (type === 'success') {
        notification.style.backgroundColor = '#d4edda';
        notification.style.color = '#155724';
        notification.style.border = '1px solid #c3e6cb';
    } else if (type === 'error') {
        notification.style.backgroundColor = '#f8d7da';
        notification.style.color = '#721c24';
        notification.style.border = '1px solid #f5c6cb';
    } else if (type === 'warning') {
        notification.style.backgroundColor = '#fff3cd';
        notification.style.color = '#856404';
        notification.style.border = '1px solid #ffeaa7';
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}
</script>

<style>
.quick-actions-panel {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.quick-actions-panel h2 {
    margin: 0 0 20px 0;
    color: #333;
    font-size: 1.5em;
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.action-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 20px;
    text-align: center;
}

.action-card h3 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 1.1em;
}

.action-card p {
    margin: 0 0 15px 0;
    color: #666;
    font-size: 0.9em;
}

.action-btn {
    display: inline-block;
    padding: 10px 20px;
    background: #007bff;
    color: white;
    text-decoration: none;
    border: none;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.action-btn:hover {
    background: #0056b3;
    text-decoration: none;
    color: white;
}

.action-btn.primary {
    background: #28a745;
}

.action-btn.primary:hover {
    background: #1e7e34;
}

.action-btn.success {
    background: #17a2b8;
}

.action-btn.success:hover {
    background: #138496;
}

.action-btn.warning {
    background: #fd7e14;
}

.action-btn.warning:hover {
    background: #e55100;
}

.status {
    font-weight: 500;
}

.status.running {
    color: #28a745;
}

.status.starting {
    color: #ffc107;
}

.status.stopped {
    color: #6c757d;
}

.status.error {
    color: #dc3545;
}
</style>
{% endblock %}